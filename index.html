<script src="./js globals/live.js"></script>
<script src="./js globals/libloader.user.js"></script>
<script src="./js globals/allfuncs.user.js"></script>
<script src="./js globals/better logs.user.js"></script>
<script src="./js globals/indexeddb ls.user.js"></script>

<!-- <script src="./eruda.js"></script> -->

<script src="./cryptojs.js"></script>
<script src="./protectedtextapi.js"></script>
<script src="./jsonblobapi.js"></script>

<link rel="stylesheet" href="style.css" />
<span class="installlinks">
  <a
    href="https://chromewebstore.google.com/detail/violentmonkey/jinjaccalgkegednnccohejagnlnfdag"
    target="_blank"
    >violentmonkey</a
  >
  <a href="./globalrequest.user.js" target="_self">globalrequest</a>
</span>
<button id="download">download</button>
<input
  type="text"
  autocomplete="off"
  id="username"
  placeholder="enter your name here"
/>
<input type="checkbox" name="notification" id="notification" />
<label for="notification">notify on data change</label>
<input
  type="checkbox"
  name="createLocalBackups"
  id="createLocalBackups"
/>
<label for="createLocalBackups">createLocalBackups</label>
<br />
<span>left click for yes, right click for no</span>
<div id="sticky">
  <input
    autocomplete="off"
    type="text"
    id="taskname"
    placeholder="name of new task"
  />
  <button id="addtask">add task</button>
</div>
<table id="table">
  <thead>
    <tr style="position: sticky">
      <th>name</th>
      <th>PLAYER COUNT</th>
      <th>likes</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
  // ==UserScript==
  // @name         lib:toast
  // @version      3
  // @description  allows showing toast message
  // @license      GPLv3
  // @run-at       document-start
  // @author       rssaromeo
  // @match        *://*/*
  // @tag          lib
  // @exclude      /livereload.net\/files\/ffopen\/index.html$/
  // @icon         data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAAAAXNSR0IB2cksfwAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAHJQTFRFAAAAEIijAo2yAI60BYyuF4WaFIifAY6zBI2wB4usGIaZEYigIoiZCIyrE4igG4iYD4mjEomhFoedCoqpDIqnDomlBYyvE4efEYmiDYqlA42xBoytD4mkCYqqGYSUFYidC4qoC4upAo6yCoupDYqmCYur4zowOQAAACZ0Uk5TAO////9vr////1+/D/+/L+/Pf/////+f3///////H4////////+5G91rAAACgUlEQVR4nM2Y22KjIBCGidg1264liZqDadK03X3/V2wNKHMC7MpF/xthHD5mgERAqZhWhfYqH6K+Qf2qNNf625hCoFj9/gblMUi5q5jLkXLCKudgyiRm0FMK82cWJp1fLbV5VmvJbCIc0GCYaFqqlDJgADdBjncqAXYobm1xh72aFMflbysteFfdy2Yi1XGOm5HGBzQ1dq7TzEoxjeNTjQZb7VA3e1c7+ImgasAgQ9+xusNVNZIo5xmOMgihIS2PbCQIiHEUdTvhxCcS/kPomfFI2zHy2PkWmA6aNatIJpKFJyekyy02xh5Y3DI9T4aOT6VhIUrsNTFp1pf79Z4SIIVDegl6IJO6cHiL/GimIZDhgTu/BlYWCQzHMl0zBWT/T3KAhtxOuUB9FtBrpsz0RV4xsjHmW+UCaffcSy/5viMGer0/6HdFNMZBq/vjJL38H9Dqx4Fuy0Em12DbZy+9pGtiDijbglwAehyj11n0tRD3WUBm+lwulE/8h4BuA+iWAQQnteg2Xm63WQLTpnMnpjdge0Mgu/GRPsV4xdjQ94Lfi624fabhDkfUqIKNrM64Q837v8yL0prasepCgrtvw1sJpoqanGEX7b5mQboNW8eawXaWXTMfMGxub472hzWzHSn6Sg2G9+6TAyRruE71s+zAzjWaknoyJCQzwxrghH2k5FDT4eqWunuNxyN9QCGcxVod5oADbYnIUkDTGZEf1xDJnSFteQ3KdsT8zYDMQXcHxsevcLH1TrsABzkNPyA/L7b0jg704viMMlpQI96WsHknCt/3YH0kOEo9zcGkwrFK39ck72rmoehmKqo2RKlilzSy/nJKEV45CT38myJp456fezktHjN5aeMAAAAASUVORK5CYII=
  // @grant        none
  // @namespace https://greasyfork.org/users/1184528
  // @downloadURL https://update.greasyfork.org/scripts/491569/lib%3Atoast.user.js
  // @updateURL https://update.greasyfork.org/scripts/491569/lib%3Atoast.meta.js
  // ==/UserScript==
  ;(async () => {
    const a = loadlib("allfuncs")
    await a.bodyload()
    var toastbox = a.createelem(document.body, "div", {
      id: "toastbox",
    })
    function toast(msg, color) {
      var x = a.createelem(toastbox, "div", {
        class: "toast",
        backgroundColor:
          {
            red: "rgb(255, 127, 127)",
            yellow: "rgb(255, 246, 127)",
            green: "rgb(127, 255, 138)",
          }[color] ?? color,
        innerHTML: msg,
      })
      setTimeout(((x) => x?.remove?.()).bind(null, x), 2800)
      return x
    }
    loadlib("libloader").savelib("toast", toast)
    a.createelem(document.body, "style", {
      innerHTML: `#toastbox {
      z-index: 2;
      display: flex;
      flex-direction: column;
      width: fit-content;
      height: fit-content;
      background-color: transparent;
      min-height: 100px;
      position: fixed;
      top: 10px;
      right: 10px;
      gap: 20px;
      opacity: 0.7;
      font-size: large;
      font-weight: 150;
      pointer-events: none;
    }

    .toast {
      text-align: center;
      line-height: 40px;
      height: 40px;
      padding: 10px;
      display:flex;justify-content:center;align-items:center;
      border-radius: 20px;
      min-width: 200px;
      color: #000;
      opacity: 1;
      animation: fade 0.5s 1;
      animation-fill-mode: forwards;
      animation-delay: 2s;
    }
    @keyframes fade {
      0% {
        opacity: 0.7;
      }

      100% {
        opacity: 0;
      }
    }`,
    })
  })()

  async function tryLocalSave(data, extra = "") {
    if (localStorage.createLocalBackups == "true") {
      ls.folder ??= await a.getfolder(true)
      saveToFile(
        ls.folder,
        "AUTO summer test backup - " +
          Date.now() +
          (extra ? " - " + extra : "") +
          ".json",
        data
      )
      return 1
    }
    return 0
    async function saveToFile(handle, name, data) {
      const fileHandle = await handle.getFileHandle(name, {
        create: true,
      })
      const writableStream = await fileHandle.createWritable()
      await writableStream.write(data)
      await writableStream.close()
    }
  }

  // add my ideas
  // add way to filter by users liked/disliked/likable
  // add way to filter by valid player counts
  // add reload button/polling reload
  const a = loadlib("allfuncs")

  a.listen(window, "scroll", function () {
    const stickyElement = a.qs("#sticky")
    if (window.scrollY >= 50) {
      stickyElement.classList.add("scrolled")
    } else {
      stickyElement.classList.remove("scrolled")
    }
  })
  a.qs("#notification").checked = localStorage.sendnoti == "true"
  a.listen(a.qs("#notification"), "change", (e) => {
    localStorage.sendnoti = String(a.qs("#notification").checked)
  })
  a.qs("#createLocalBackups").checked =
    localStorage.createLocalBackups == "true"
  a.listen(a.qs("#createLocalBackups"), "change", (e) => {
    localStorage.createLocalBackups = String(
      a.qs("#createLocalBackups").checked
    )
  })
  a.listen(a.qs("#download"), "click", async (e) => {
    a.download(await API.load(), "summer test backup - " + Date.now())
  })
  a.qs("#username").value = localStorage.name ?? ""
  a.listen(a.qs("#username"), "change", () => {
    localStorage.name = a.qs("#username").value
  })
  a.listen(a.qs("#addtask"), "click", () => {
    addNewEvent(a.qs("#taskname").value)
  })
  window.globalrequest = (data) => {
    if (typeof data == "string") data = { url: data }
    var { url, method, headers } = data
    headers ??= []
    method ??= "GET"
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest()

      xhr.open(method, url, true)

      for (const key in headers) {
        xhr.setRequestHeader(key, headers[key])
      }

      xhr.onload = function () {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve({ text: xhr.responseText })
        } else {
          error(xhr.statusText, xhr.responseText)
          reject(new Error(xhr.responseText))
        }
      }

      xhr.onerror = function () {
        reject(new Error("Network Error"))
      }

      xhr.send(data.body ? data.body : undefined)
    })
  }
  if (window.globalrequest) {
    start()
  } else {
    var timeout = setTimeout(() => {
      if (!window.globalrequest) {
        alert(
          "click the link for violentmonkey, install the extension then click globalrequest and install that too"
        )
      }
    }, 4000)
    var interval = setInterval(() => {
      if (window.globalrequest) {
        clearTimeout(timeout)
        clearInterval(interval)
        start()
      }
    }, 100)
  }
  function sendnoti() {
    if (!("Notification" in window)) {
      alert("This browser does not support desktop notification")
    } else if (Notification.permission === "granted") {
      const notification = new Notification("data updated!")
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then((permission) => {
        if (permission === "granted") {
          const notification = new Notification("data updated!")
        }
      })
    }
  }
  async function start() {
    await loadlib("libloader").waitforlib("toast")
    const toast = loadlib("toast")
    window.toast = toast
    const ls = await loadlib("indexeddb ls")("summer test")
    window.ls ??= ls
    a.qs(".installlinks").classList.add("hide")
    const API = (window.API = await new jsonblobapi(
      "1352826891148648448"
    ))
    // const API = (window.API = await new protectedtextapi(
    //   "summerplans",
    //   "summertest"
    // ))
    var data = JSON.parse((window.lastdata = await API.load()))
    await a.bodyload()
    loadAllData(data)
  }
  function loaddata(idx, data) {
    const table = a.qs("#table>tbody")
    var { name, likes, validPlayerCounts, desc } = data
    validPlayerCounts ??= []
    desc ??= ""
    if (table.children.length <= idx)
      table.appendChild(
        a.newelem(
          "tr",
          {
            class: "row",
          },
          [
            a.newelem(
              "td",
              {
                display: "flex",
                flexDirection: "column",
                gap: "5px",
              },
              [
                a.newelem("input", {
                  autocomplete: "off",
                  fieldSizing: "content",
                  maxWidth: "190px",
                  minWidth: "40px",
                  class: "taskname",
                  onfocus() {
                    window.intextarea = true
                  },
                  onblur() {
                    window.intextarea = false
                  },
                  onchange(e) {
                    renameEvent(this.oldname, this.value)
                  },
                }),
                a.newelem("button", {
                  innerHTML: "delete",
                  id: "delete",
                  onclick(e) {
                    if (confirm(this.thingname))
                      removeEvent(this.thingname)
                  },
                }),
              ]
            ),
            a.newelem("td", {}, [
              a.newelem("div", {
                textContent: 1,
                class: "playerCount",
                onclick: validPlayerCount,
                oncontextmenu: invalidPlayerCount,
              }),
              a.newelem("div", {
                textContent: 2,
                class: "playerCount",
                onclick: validPlayerCount,
                oncontextmenu: invalidPlayerCount,
              }),
              a.newelem("div", {
                class: "playerCount",
                textContent: 3,
                onclick: validPlayerCount,
                oncontextmenu: invalidPlayerCount,
              }),
              a.newelem("div", {
                textContent: 4,
                class: "playerCount",
                onclick: validPlayerCount,
                oncontextmenu: invalidPlayerCount,
              }),
              a.newelem("div", {
                textContent: 5,
                class: "playerCount",
                onclick: validPlayerCount,
                oncontextmenu: invalidPlayerCount,
              }),
            ]),
            a.newelem(
              "td",
              {
                gap: "2px",
              },
              likes.map((e) =>
                a.newelem("div", {
                  padding: "2px",
                  onclick(e) {
                    e.preventDefault()
                    if (this.username == localStorage.name) {
                      like(this.thingname, 1)
                    }
                  },
                  oncontextmenu(e) {
                    e.preventDefault()
                    if (this.username == localStorage.name) {
                      like(this.thingname, -1)
                    }
                  },
                })
              )
            ),
            a.newelem("td", {}, [
              a.newelem("textarea", {
                autocomplete: "off",
                class: "desc",
                onchange: updateDesc,
                onfocus() {
                  window.intextarea = true
                },
                onblur() {
                  window.intextarea = false
                },
              }),
            ]),
          ]
        )
      )
    var child = [...table.children][idx]
    a.qs("tr>td>button#delete", child).thingname =
      a.qs("tr>td>input", child).oldname =
      a.qs("tr>td>input", child).value =
        name
    var validPlayerCountsElems = a.qsa(
      "tr>td:nth-of-type(2)>div.playerCount",
      child
    )
    for (let child of validPlayerCountsElems) {
      child.thingname = name
      child.classList.remove(
        !validPlayerCounts.includes(child.textContent)
          ? "valid"
          : "invalid"
      )
      child.classList.add(
        validPlayerCounts.includes(child.textContent)
          ? "valid"
          : "invalid"
      )
    }
    var likesParentElem = a.qs("tr>td:nth-of-type(3)", child)
    var ii = 0
    for (let ii = 0; ii < likes.length; ii++) {
      let child = [...likesParentElem.children][ii]
      var thislike = likes.sort((a, b) =>
        a.name.localeCompare(b.name)
      )[ii]
      child.username = child.textContent = thislike.name
      child.thingname = name
      child.className =
        thislike.liked == 1
          ? "liked"
          : thislike.liked == -1
          ? "disliked"
          : "likable"
    }
    var descElem = a.qs("tr>td:nth-of-type(4)>textarea.desc", child)
    descElem.value = desc
    descElem.thingname = name
  }

  async function like(thing, liked) {
    log("loading like")
    var data = JSON.parse(await API.load())
    log("done loading like")
    try {
      data
        .find((e) => e.name == thing)
        .likes.find((e) => e.name == localStorage.name).liked = liked
      await API.save(JSON.stringify(data))
    } catch (e) {}
    loadAllData(data)
  }

  function loadAllData(data) {
    data = data.toReversed()
    for (var i = 0; i < data.length; i++) {
      loaddata(i, data[i])
    }
    var children = a.qsa("table>tbody>*")
    while (children.length > data.length) {
      children.pop().remove()
    }
  }

  async function updateDesc(event) {
    event.preventDefault()
    try {
      log("loading desc")
      var data = JSON.parse(await API.load())
      log("done loading desc")
      var thing = data.find((e) => e.name == event.target.thingname)
      thing.desc = event.target.value
      loadAllData(data)
      await API.save(JSON.stringify(data))
      loadAllData(data)
    } catch (e) {}
    loadAllData(data)
  }

  async function validPlayerCount(event) {
    event.preventDefault()
    var data = JSON.parse(await API.load())
    try {
      var thing = data.find((e) => e.name == event.target.thingname)
      thing.validPlayerCounts ??= []
      if (
        !thing.validPlayerCounts.includes(event.target.textContent)
      ) {
        thing.validPlayerCounts.push(event.target.textContent)
        loadAllData(data)
        await API.save(JSON.stringify(data))
        loadAllData(JSON.parse(await API.load()))
      }
    } catch (e) {
      loadAllData(data)
    }
  }
  async function invalidPlayerCount(event) {
    event.preventDefault()
    var data = JSON.parse(await API.load())
    try {
      var thing = data.find((e) => e.name == event.target.thingname)
      thing.validPlayerCounts ??= []
      if (
        thing.validPlayerCounts.includes(event.target.textContent)
      ) {
        thing.validPlayerCounts.splice(
          thing.validPlayerCounts.indexOf(event.target.textContent),
          1
        )
        loadAllData(data)
        await API.save(JSON.stringify(data))
        loadAllData(JSON.parse(await API.load()))
      } else {
        loadAllData(data)
      }
    } catch (e) {
      loadAllData(data)
    }
  }
  async function addNewEvent(name) {
    var data = JSON.parse(await API.load())
    data.push({
      name,
      likes: [
        { name: "jaden", liked: 0 },
        { name: "river", liked: 0 },
        { name: "mom", liked: 0 },
        { name: "pheonix", liked: 0 },
        { name: "mike", liked: 0 },
      ],
    })
    loadAllData(data)
    await API.save(JSON.stringify(data))
    loadAllData(JSON.parse(await API.load()))
  }

  async function removeEvent(name) {
    var data = JSON.parse(await API.load())
    try {
      data.splice(data.indexOf(data.find((e) => e.name == name)), 1)
      await API.save(JSON.stringify(data))
      loadAllData(data)
      loadAllData(JSON.parse(await API.load()))
    } catch (e) {
      loadAllData(data)
    }
  }
  async function renameEvent(oldname, newname) {
    var data = JSON.parse(await API.load())
    try {
      data.find((e) => e.name == oldname).name = newname
      loadAllData(data)
      await API.save(JSON.stringify(data))
      loadAllData(JSON.parse(await API.load()))
    } catch (e) {
      loadAllData(data)
    }
  }
</script>
